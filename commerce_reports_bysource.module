<?php

require __DIR__ . '/vendor/autoload.php';

use Symfony\Component\HttpFoundation\Request;

/**
 * Implements hook_init()
 */
function commerce_reports_bysource_init(){

    $request = Request::createFromGlobals();
    $src_session = NULL;

    $src_tmpget = $request->query->get('src');
    if ( isset($_SESSION) && array_key_exists('commerce_reports_bysource',$_SESSION) && array_key_exists('src_code',$_SESSION['commerce_reports_bysource']) ){
        $src_session = $_SESSION['commerce_reports_bysource']['src_code'];
    }

/*
    g s
    0 0 direct
    0 1 noting
    1 0 insert g > s
    1 1 insert g > s
*/
    /*if ( empty($src_tmpget) && empty($src_session) ){
        $_SESSION['commerce_reports_bysource']['src_code'] = 'Direct';
    } else */
    if ( isset($src_tmpget) && empty($src_session) ) {
        $_SESSION['commerce_reports_bysource']['src_code'] = $src_tmpget;
	} else if ( isset($src_tmpget) && isset($src_session) ) {
        $_SESSION['commerce_reports_bysource']['src_code'] = $src_tmpget;
	}

    //drupal_set_message("<pre>" . print_r(array('src'=>$src_tmpget,'session'=>$_SESSION['commerce_reports_bysource']), 1) . "</pre>");

}

/**
 * Action for rule commerce_reports_bysource_classify
 */
function commerce_reports_bysource_classify_order($order){

//set values
    unset($term);
    $src_code = $_SESSION['commerce_reports_bysource']['src_code'];

    if ( isset($src_code) ) {

        $vocabulary = 'commerce_reports_bysource';

        $taxonomy = taxonomy_get_term_by_name($src_code, $vocabulary );
        if isset($taxonomy){
        	$taxonomy_item = array_pop($taxonomy);
        	$tid = $taxonomy_item->tid;	
        }
            $tid = _create_source($vocabulary, $src_code);
        }

        //drupal_set_message("<pre>" . print_r(array('tid_to_insert'=>$tid),1) . "</pre>");
        $order = entity_metadata_wrapper('commerce_order', $order);

        //classify order by source and save
        $order->field_reports_bysource->set(intval($tid));
        $order->save();

        //drupal_set_message("<pre>order: \n" . print_r($order,1) . "</pre>");

        //unset($_SESSION['commerce_reports_bysource']);

    }

}

/**
 * Implements hook_views_api().
 */
function commerce_reports_bysource_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'commerce_reports_bysource') . '/views',
  );
}

/**
 * Auxiliary function for create taxonomy term of the commerce_reports_bysource
 */

function _create_source($vocabulary=NULL,$src=NULL){
    $tid = NULL;

    if ( !empty($vocabulary) && !empty($src) ){
            $vocabulary_names = taxonomy_vocabulary_get_names();
            $vid = $vocabulary_names[$vocabulary]->vid;
            $newsrc = (object) array(
                    'name' => $src,
                    'description' => 'Source: ' . $src,
                    'vid' => $vid,
                    );
            taxonomy_term_save($newsrc);
            $taxonomy = taxonomy_get_term_by_name($src, $vocabulary);
            $taxonomy_item = array_pop($taxonomy);
            $tid = $taxonomy_item->tid;
    }

    return $tid;
}
